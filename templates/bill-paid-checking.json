{
  "_meta": {
    "name": "Bill Paid from Checking Account",
    "description": "Record a vendor bill paid directly from business checking account",
    "scenario": "Invoice received and paid via check, ACH, or bank transfer",
    "accounts": {
      "expense": "The expense account to debit",
      "checking": "Checking Account asset (14) - credits decrease cash balance"
    }
  },
  "_variables": {
    "vendor_id": "integer - Vendor record ID",
    "bill_number": "string - Invoice/bill number from vendor",
    "date_timestamp": "integer - Unix timestamp for bill date",
    "due_date_timestamp": "integer - Unix timestamp for due date",
    "payment_date_timestamp": "integer - Unix timestamp for payment date (may differ from bill date)",
    "amount": "number - Total amount including tax",
    "expense_account_id": "integer - Expense account ID to debit",
    "line_description": "string - Description for bill line",
    "vendor_name": "string - Vendor name for transaction descriptions",
    "check_number": "string - Check number or payment reference"
  },
  "_sequence": [
    "1. Create Bill record → get bill_id",
    "2. Create BillLine → links to bill_id",
    "3. Create entry Transaction → get entry_txn_id",
    "4. Create entry TransactionLines (Dr Expense, Cr AP)",
    "5. Update Bill.EntryTransaction → link to entry_txn_id",
    "6. Create payment Transaction → get payment_txn_id",
    "7. Create payment TransactionLines (Dr AP, Cr Checking)",
    "8. Create BillPayment record",
    "9. Update Bill.Status → 'Paid'",
    "10. Upload attachments (Invoice, Receipt)",
    "11. Run audit checks"
  ],
  "records": {
    "bill": {
      "_doc": "Step 1: Create Bill header. Do NOT include Amount - it's a formula field.",
      "_table": "Bills",
      "_operation": "add_records",
      "payload": {
        "Vendor": "{{vendor_id}}",
        "BillNumber": "{{bill_number}}",
        "BillDate": "{{date_timestamp}}",
        "DueDate": "{{due_date_timestamp}}",
        "Status": "Open",
        "Memo": "{{line_description}}"
      }
    },
    "bill_line": {
      "_doc": "Step 2: Create BillLine. This populates the Bill.Amount formula.",
      "_table": "BillLines",
      "_operation": "add_records",
      "_requires": ["bill_id"],
      "payload": {
        "Bill": "{{bill_id}}",
        "Account": "{{expense_account_id}}",
        "Description": "{{line_description}}",
        "Amount": "{{amount}}"
      }
    },
    "entry_transaction": {
      "_doc": "Step 3: Create entry transaction header.",
      "_table": "Transactions",
      "_operation": "add_records",
      "payload": {
        "Date": "{{date_timestamp}}",
        "Description": "{{vendor_name}} - Invoice {{bill_number}}",
        "Reference": "{{bill_number}}",
        "Status": "Posted"
      }
    },
    "entry_transaction_lines": {
      "_doc": "Step 4: Create entry transaction lines. Debit expense, credit AP.",
      "_table": "TransactionLines",
      "_operation": "add_records",
      "_requires": ["entry_txn_id"],
      "payload": [
        {
          "Transaction": "{{entry_txn_id}}",
          "Account": "{{expense_account_id}}",
          "Debit": "{{amount}}",
          "Credit": 0,
          "Memo": "{{line_description}}"
        },
        {
          "Transaction": "{{entry_txn_id}}",
          "Account": 4,
          "Debit": 0,
          "Credit": "{{amount}}",
          "Memo": "Accounts Payable"
        }
      ]
    },
    "link_bill_to_entry": {
      "_doc": "Step 5: Link Bill to entry transaction.",
      "_table": "Bills",
      "_operation": "update_records",
      "_requires": ["bill_id", "entry_txn_id"],
      "payload": {
        "id": "{{bill_id}}",
        "fields": {
          "EntryTransaction": "{{entry_txn_id}}"
        }
      }
    },
    "payment_transaction": {
      "_doc": "Step 6: Create payment transaction header.",
      "_table": "Transactions",
      "_operation": "add_records",
      "payload": {
        "Date": "{{payment_date_timestamp}}",
        "Description": "Payment to {{vendor_name}}",
        "Reference": "{{check_number}}",
        "Status": "Cleared"
      }
    },
    "payment_transaction_lines": {
      "_doc": "Step 7: Create payment transaction lines. Debit AP, credit Checking.",
      "_table": "TransactionLines",
      "_operation": "add_records",
      "_requires": ["payment_txn_id"],
      "payload": [
        {
          "Transaction": "{{payment_txn_id}}",
          "Account": 4,
          "Debit": "{{amount}}",
          "Credit": 0,
          "Memo": "Accounts Payable"
        },
        {
          "Transaction": "{{payment_txn_id}}",
          "Account": 14,
          "Debit": 0,
          "Credit": "{{amount}}",
          "Memo": "Checking Account"
        }
      ]
    },
    "bill_payment": {
      "_doc": "Step 8: Create BillPayment linking bill to payment transaction.",
      "_table": "BillPayments",
      "_operation": "add_records",
      "_requires": ["bill_id", "payment_txn_id"],
      "payload": {
        "Bill": "{{bill_id}}",
        "Transaction": "{{payment_txn_id}}",
        "Amount": "{{amount}}",
        "PaymentDate": "{{payment_date_timestamp}}"
      }
    },
    "mark_paid": {
      "_doc": "Step 9: Update Bill status to Paid.",
      "_table": "Bills",
      "_operation": "update_records",
      "_requires": ["bill_id"],
      "payload": {
        "id": "{{bill_id}}",
        "fields": {
          "Status": "Paid"
        }
      }
    }
  },
  "journal_entries": {
    "_doc": "Summary of journal entries created by this template",
    "entry": {
      "description": "Record expense and liability",
      "debits": [{"account": "Expense Account", "amount": "{{amount}}"}],
      "credits": [{"account": "Accounts Payable (2000)", "amount": "{{amount}}"}]
    },
    "payment": {
      "description": "Record payment from checking - decreases cash",
      "debits": [{"account": "Accounts Payable (2000)", "amount": "{{amount}}"}],
      "credits": [{"account": "Checking Account (1001)", "amount": "{{amount}}"}]
    }
  }
}
